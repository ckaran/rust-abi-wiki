<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Generics - Rust ABI Wiki</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro/intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/what_is_an_ABI.html"><strong aria-hidden="true">1.1.</strong> What is an ABI</a></li><li class="chapter-item expanded "><a href="../intro/history.html"><strong aria-hidden="true">1.2.</strong> A Short History</a></li><li class="chapter-item expanded "><a href="../intro/ip_summary.html"><strong aria-hidden="true">1.3.</strong> Initial Proposal Summary</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/initial_proposal.html"><strong aria-hidden="true">1.3.1.</strong> Initial Proposal</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../discussion/discussion.html"><strong aria-hidden="true">2.</strong> Summary of the Discussion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../discussion/repr_c.html"><strong aria-hidden="true">2.1.</strong> repr(C) as the Lowest Common Denominator</a></li><li class="chapter-item expanded "><a href="../discussion/terms.html"><strong aria-hidden="true">2.2.</strong> A Clarification of Terms</a></li><li class="chapter-item expanded "><a href="../discussion/generics.html" class="active"><strong aria-hidden="true">2.3.</strong> Generics</a></li><li class="chapter-item expanded "><a href="../discussion/swift_abi.html"><strong aria-hidden="true">2.4.</strong> The Swift ABI?</a></li><li class="chapter-item expanded "><a href="../discussion/plugin_architecture.html"><strong aria-hidden="true">2.5.</strong> A Plugin-Style Architecture</a></li><li class="chapter-item expanded "><a href="../discussion/layout.html"><strong aria-hidden="true">2.6.</strong> Laying out Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../discussion/memory_ffi.html"><strong aria-hidden="true">2.6.1.</strong> Memory Management Across FFI</a></li></ol></li><li class="chapter-item expanded "><a href="../discussion/calling.html"><strong aria-hidden="true">2.7.</strong> Calling Conventions</a></li><li class="chapter-item expanded "><a href="../discussion/selection.html"><strong aria-hidden="true">2.8.</strong> ABI Selection</a></li><li class="chapter-item expanded "><a href="../discussion/one_ring.html"><strong aria-hidden="true">2.9.</strong> OneRing and ABI Boundaries</a></li><li class="chapter-item expanded "><a href="../discussion/niches.html"><strong aria-hidden="true">2.10.</strong> Niches</a></li><li class="chapter-item expanded "><a href="../discussion/glue.html"><strong aria-hidden="true">2.11.</strong> API/FFI, or, Code as Glue</a></li><li class="chapter-item expanded "><a href="../discussion/final_picture.html"><strong aria-hidden="true">2.12.</strong> A Final Picture</a></li></ol></li><li class="chapter-item expanded "><a href="../rust_compiler/rust_compiler.html"><strong aria-hidden="true">3.</strong> Rust's Compiler Infrastructure</a></li><li class="chapter-item expanded "><a href="../towards_rfc/towards_rfc.html"><strong aria-hidden="true">4.</strong> Towards an RFC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../towards_rfc/mvs.html"><strong aria-hidden="true">4.1.</strong> A Minimum Viable Subset</a></li></ol></li><li class="chapter-item expanded "><a href="../references_and_resources/useful_references.html"><strong aria-hidden="true">5.</strong> References and Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Rust ABI Wiki</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#generics" id="generics">Generics</a></h1>
<blockquote>
<blockquote>
<p>The way Rust compiles generics, for example, necessarily inlines lots of &quot;internal&quot; library code (full of hard-coded field offsets, type sizes, etc.) into consumers of the library.</p>
</blockquote>
<p>Addendum: when I wrote this sentence I also fell into the trap of focusing just on the &quot;ABI&quot; in the narrow sense of choices made while mapping Rust to machine code. Just as important is the fact that the library's code is copied into the consumer at all. So if a bug is fixed in the library, even if you can recompile that library and re-link everything (because you went through great effort to make type sizes and calling conventions and so on stable), the bug fix still won't reach the applications that use the library. Or will reach it inconsistently depending on where a fresh copy of the generic code was instantiated and where an existing copy of the code was reused (see: -Zshare-generics flag).</p>
<p>— <code>@hanna-kruppe</code>, IRLO</p>
</blockquote>
<blockquote>
<p>Generics are not a problem as long as all types are known in the interface exposed through the ABI. So it wouldn't be a problem to return <code>Result&lt;i32, String&gt;</code> or even <code>Result&lt;(), Box&lt;dyn Error&gt;&gt;</code> (assuming trait objects have defined ABI).</p>
<p>They're only an issue for functions like <code>pub fn generic&lt;T, E&gt;() -&gt; Result&lt;T, E&gt;</code> that can't be monomorphized on the library side. For these functions the options are:</p>
<ul>
<li>
<p>Just forbid them. Library interfaces would have to use dyn Trait or concrete types instead. IMHO this is quite sensible limitation, especially for an MVP.</p>
</li>
<li>
<p>Require defining ahead of time which parameters can be used, and compile monomorphic versions just for these types (similar to template instantiations in C++)</p>
</li>
<li>
<p>Do what Swift does and compile a universal version of the generic function that uses run time type information to support arbitrary types. It's a very clever approach from ABI perspective, but it's equivalent of changing everything into dyn Trait, so it may be a poor fit for Rust.</p>
</li>
</ul>
<p>— <code>@kornel</code>, IRLO</p>
</blockquote>
<blockquote>
<blockquote>
<p>Just forbid them. Library interfaces would have to use dyn Trait or concrete types instead. IMHO this is quite sensible limitation, especially for an MVP</p>
</blockquote>
<p>I think doing that is very reasonable. Then the library developer could still get the second and third behaviors in many cases by doing something like:</p>
<pre><code>pub fn int_generic() -&gt; Result&lt;i32, Box&lt;dyn Error&gt;&gt; {
    return generic&lt;i32, Box&lt;dyn Error&gt;&gt;();
}

pub fn dyn_generic() -&gt; Result&lt;Box&lt;dyn Any&gt;, Box&lt;dyn Error&gt;&gt; {
    return generic&lt;Box&lt;dyn Any&gt;, Box&lt;dyn Error&gt;&gt;();
}
</code></pre>
<p>— <code>@tmccombs</code>, IRLO</p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li>Just forbid them. Library interfaces would have to use dyn Trait or concrete types instead. IMHO this is quite sensible limitation, especially for an MVP.</li>
<li>Do what Swift does and compile a universal version of the generic function that uses run time type information to support arbitrary types. It's a very clever approach from ABI perspective, but it's equivalent of changing everything into dyn Trait , so it may be a poor fit for Rust.</li>
</ul>
</blockquote>
<p>Both these options make sense; generally speaking, I think Rust is leaving a lot of potential on the table with its current dyn-safe rules. Finding a way to make more traits dyn-safe (for instance, by adding workarounds to the &quot;no associated constants&quot; rule) would help with both of the above options.</p>
<p>Also, implementing the second one would probably help a lot with compile times in debug mode, since it removes the need for monomorphizing most template functions.</p>
<p>— <code>@PoignardAzur</code>, IRLO</p>
</blockquote>
<blockquote>
<p>How about defining a stable ABI subset for &quot;easy&quot; parts of Rust, such as non-inline functions, non-generic structs?</p>
<p>Then std could be split internally into std-abi-stable and std-hard-parts. Crates could link to std-abi-stable dynamically to reduce bloat, while linking std-hard-parts statically. I imagine over time, as more ABI and std features are set in stone, more things would be moved to std-abi-stable part.</p>
<p>For example, path functions in libstd are generic for P: AsRef<Path>, but std already uses a pattern of</p>
<pre><code>fn join&lt;P&gt;(&amp;self, p: P) { self._join(p.as_ref()) }
</code></pre>
<p>to reduce generics bloat and defer implementation to non-generic _join method. That non-generic implementation could be moved to an ABI-stable library without need to support generics in the ABI.</p>
<p>This is similar to how C libraries use macros and inline functions in the .h files. The header files are the API, but not everything is in the ABI. The ABI is only for whatever these macros expand to.</p>
<p>— <code>@kornel</code>, IRLO</p>
</blockquote>
<blockquote>
<p>@kornel I do want to see a &quot;safe ABI&quot; subset, which is bigger than C and smaller than fully general Rust.</p>
<p>However, having a shared library for cases like _join would require making the internal _join interface stable, which would increase our stability surface area. And in practice, I don't think most people who want shared library support specifically want it to save disk storage space. They do sometimes want it to save RAM, and a shared library might help a little with that when multiple Rust programs are running simultaneously. But mostly, shared libraries make distribution maintenance easier: you can upgrade a library without rebuilding the world. This wouldn't necessarily solve that problem. And I think it would in practice make distribution of Rust binaries harder for many people, because then they'd need to supply the matching library.</p>
<p>— <code>@josh</code>, IRLO</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../discussion/terms.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../discussion/swift_abi.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../discussion/terms.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../discussion/swift_abi.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
